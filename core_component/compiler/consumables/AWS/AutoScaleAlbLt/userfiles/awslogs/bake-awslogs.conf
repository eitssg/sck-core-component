{% import "AWS/_shared/vars/names.j2" as names with context %}
# -------------------------------------------
# THIS FILE WAS GENERATED BY AWS PIPELINE
# -------------------------------------------

[general]
state_file = /var/lib/awslogs/agent-state
use_gzip_http_content_encoding = gzip
queue_size = 10

{% if 'BakeInstance' in app[component_name].Configuration %}
{% set target_resource = app[component_name].Configuration.BakeInstance %}
{% set image_alias = target_resource.Properties.ImageId | image_name %}
{% else %}
{% set target_resource = app[component_name].Configuration.launchTemplate %}
{% set image_alias = target_resource.Properties.LaunchTemplateData.ImageId | image_name %}
{% endif %}

{% if 'amazon-linux-2' in image_alias %}

{% else %}
[/var/log/messages]
datetime_format = %b %d %H:%M:%S
file = /var/log/messages
buffer_duration = 5000
log_stream_name = bake/var/log/messages
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}
{% endif %}

[/var/log/secure]
datetime_format = %b %d %H:%M:%S
file = /var/log/secure
buffer_duration = 5000
log_stream_name = bake/var/log/secure
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}

[/var/log/cfn-init.log]
file = /var/log/cfn-init.log
log_stream_name = bake/var/log/cfn-init.log
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}

[/var/log/cfn-init-cmd.log]
file = /var/log/cfn-init-cmd.log
log_stream_name = bake/var/log/cfn-init-cmd.log
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}

[/var/log/cloud-init.log]
file = /var/log/cloud-init.log
log_stream_name = bake/var/log/cloud-init.log
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}

[/var/log/cloud-init-output.log]
file = /var/log/cloud-init-output.log
log_stream_name = bake/var/log/cloud-init-output.log
initial_position = start_of_file
log_group_name = {{ names.log_group_name }}

{% set logs = app[component_name] | extract('Configuration.BakeInstance.Metadata."Pipeline::Agents".awslogs.Logs', []) %}
{% for log_stream in logs %}
[{{ log_stream.Log_Stream_Name | d(log_stream.File) | replace("*", "x") }}]
file = {{ log_stream.File }}
log_group_name = {{ names.log_group_name }}
log_stream_name = bake{{ log_stream.Log_Stream_Name | d(log_stream.File) | replace("*", "x") }}
initial_position = {{ log_stream.Initial_Position | d('start_of_file') }}
{% if log_stream.Datetime_Format is defined %}
datetime_format = {{ log_stream.Datetime_Format }}
{% endif %}
{% if log_stream.Buffer_Duration is defined %}
buffer_duration = {{ log_stream.Buffer_Duration }}
{% endif %}
{% if log_stream.Batch_Size is defined %}
batch_size = {{ log_stream.Batch_Size }}
{% endif %}
{% if log_stream.File_Fingerprint_Lines is defined %}
file_fingerprint_lines = {{ log_stream.File_Fingerprint_Lines }}
{% endif %}

{% endfor %}
